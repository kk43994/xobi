# 待补齐/未完成功能清单（面向“共享项目/素材/任务”的整合）

> 这是“平台化整合”必然会缺的东西：不是某个页面没做，而是底层能力未统一。  
> 你补充的业务前提：**Excel 只是批量桥接手段**（导入/导出为上架表），最终要支持跨境电商“做完→批量导出→一键上架”。  
> 优先级：P0（必须先做，否则整合会越做越乱）→ P1 → P2。

---

## P0（必须先做）

### P0-1 统一 Job（任务）模型与 API
- 现状问题：
  - A：有 `Task` 表 + 线程池，但“active_tasks”部分是内存态
  - B：batch/style job 多为内存态/文件态，且 `/api/batch` 与 `/api/replace/batch` 语义混用
- 需要补齐：
  - 统一 Job 状态机：`pending/running/succeeded/failed/canceled`
  - 统一进度结构：`total/completed/failed` + `percent`
  - 统一 API：`GET /api/jobs`、`GET /api/jobs/:id`、`POST /api/jobs/:id/cancel`、`POST /api/jobs/:id/retry`
  - 统一“输入资产/输出资产”挂载（否则无法共享）

已完成（v1 最小可用）：
- 统一 Job 表：`xobixiangqing/backend/models/job.py`
- 统一 Jobs API：`GET /api/jobs`、`GET /api/jobs/:id`、`POST /api/jobs/:id/sync`、`POST /api/jobs/:id/cancel`、`POST /api/jobs/:id/retry`
- Dataset/工具代理的任务会写入 Job（并在门户“任务中心”可见）
- 兼容聚合：`include_legacy=1` 可聚合 A 的 Task 与 B 的 style job.json（用于过渡期“看得见”）

### P0-2 统一 Asset（素材/文件）模型
- 现状问题：
  - A：Material/ReferenceFile/Template/Pages 输出都各自落盘；B：inputs/outputs 另起一套目录
- 需要补齐：
  - 一个 Asset 表（或统一资源抽象）：type（image/file/excel/zip）、source（upload/generated/imported）、owner（project/global）、metadata（尺寸/比例/标签）
  - 版本策略：编辑/改图/替换后如何产生新版本并可回滚
  - 统一下载/预览：一套 `/assets/:id` 访问方式（前端不再关心目录结构）

已完成（v1 最小可用）：
- 统一 Asset 表：`xobixiangqing/backend/models/asset.py`
- Asset API：`POST /api/assets/upload`、`POST /api/assets/register`、`GET /api/assets`、`GET /api/assets/:id`、`GET /api/assets/:id/download`
- 兼容聚合：A 的页面图/素材/模板/导出 zip + B 的 outputs 目录（可通过 `include_legacy` 控制）
- A 代理 B 的单图/编辑器输出会注册为 Asset（`/api/tools/*`）

### P0-3 统一 Dataset（Excel 数据集）与“上架导出”模型
- 现状问题：
  - Excel 现在更像“工具页”，导入/处理/导出是一次性的；难以和项目/素材/任务打通
  - 上架导出要面对不同平台模板（字段、图片列拆分规则、变体/SKU 结构）
- 需要补齐：
  - Dataset：代表一次 Excel 导入（关联原始 Excel 资产 Asset），包含解析列、字段映射、平台模板类型等
  - DatasetItem：代表表格中的一行/一个 SKU（存 canonical 字段 + 原始行号 `_row_index`）
  - 结果字段标准化：`new_title`、`new_images`、`status`、`errors`、关联的 `asset_ids` / `project_id`
  - ExportProfile（上架模板配置）：把 canonical 字段映射回某平台 Excel（overwrite/append、多图列拆分、编码/分隔符等）
  - 允许“从 DatasetItem 一键创建/绑定 Project”：把批量数据桥接到“项目化详情页/多图生产”

已完成（v1 最小可用）：
- `taiyang.xlsx` 导出闭环：`POST /api/datasets/:id/export-excel`（overwrite/append + 可选追加 `image1..imageN`）
- 门户 Excel 数据集页已提供“导出上架 Excel”入口（导出文件会注册为 Asset，导出过程记录为 Job）
- Excel 行 → Project：已支持“行级生成/绑定 Project”（先把桥接打通，但不自动跑详情页多图生成链路）

仍待补齐（v1 后续）：
- 多平台 ExportProfile（Shopee/SHEIN/Amazon/TikTok/Temu 的字段差异与图片列规则）
- Mapping/Profile 保存（不同店铺/不同模板的字段映射可复用）
- 批量生成详情页多图（N 行 → N 个 Project → outline/desc/images）+ 回写导出（你已说先标记为“待开发”，后期再做）

### P0-4 统一“配置来源与优先级”
- 现状问题：
  - A：DB Settings > env
  - B：请求头 runtime_config > env
- 需要补齐：
  - 定义清楚：全局（系统默认）/项目级（Project Profile）/用户级（个人偏好）/一次性运行时（debug）
  - 前端设置页要能区分“写到哪里”

已完成（v1）：
- A → B 的代理调用统一从 A 的 Settings 注入 Key/Base（`xobixiangqing/backend/services/legacy_b_client.py`）

---

## P1（整合后 1~2 周内应该做）

### P1-1 Excel 模块收敛为唯一实现
- 现状：B、C、Excel智能处理 三套同源代码并行
- 需要补齐：
  - 选定唯一实现源（建议 `tupian-de-tu/backend/app/api/excel_import.py` + `tupian-de-tu/frontend/assets/js/batch-import-v2.js`）
  - 其它目录归档/作为库（避免继续漂移）

### P1-2 Batch API 语义统一
- 现状：同一个 job 可能在 `/api/batch/*` 和 `/api/replace/batch/*` 两处控制
- 需要补齐：
  - 明确 “ReplaceBatchJob / StyleBatchJob / PipelineBatchJob” 的命名与路由空间
  - 统一归口到 `/api/jobs/*`（推荐）

### P1-3 系统模板（System Templates）
- 现状：A 有 placeholder，前端也有 TemplateSelector，但缺“系统模板”
- 需要补齐：
  - 系统模板存储（内置 assets 或 DB）
  - 列表/预览/一键应用到项目

### P1-4 平台优化（Platform Optimize）
- 现状：旧前端有“平台优化 API TODO”
- 需要补齐：
  - 结合 B 的 `/api/platforms/specs` 与编辑器能力，提供：
    - 一键裁剪到规格
    - 安全区域提示（留白/文字区）
    - 导出前批量适配

---

## P2（体验增强/商业化前需要）

### P2-0 最小鉴权（暂缓，但要留钩子）
- 你说暂时不做账户系统，这没问题，但需要明确“部署边界”：
  - 如果只在本机/内网使用：可以先不做鉴权（但仍建议日志脱敏）
  - 任何形式对公网或多人共享：该项必须前置到 P0（否则 Key/数据风险很高）
- 最小方案（不做账号体系）：一个 admin token（请求头/环境变量）保护 settings/keys/job 管理等

### P2-1 搜索/标签/检索
- 素材与参考文件会爆炸增长，需要：
  - 标签、全文搜索（标题/备注/caption）
  - 过滤（项目/时间/来源/类型）

### P2-2 结构化输出（Prompt/Outline/Desc）
- A 的 `ai_service.py` 标记了 TODO：structured output
- 建议：
  - Outline/Desc 用结构化 schema（减少解析失败）
  - 统一语言策略与术语表

### P2-3 Job 可观测性
- 任务日志、重试策略、失败原因聚类、成本/耗时统计
