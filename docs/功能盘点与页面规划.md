# 功能盘点与页面规划（共享项目/素材/任务版）

> 目标：先“摸清楚现在到底有什么”，再在 **共享 Project / Asset / Job** 的前提下，规划统一门户（前端采用 Ant Design X）。

本文件是人工梳理 + 代码扫描的融合结果。API 端点明细见：`功能盘点_API端点清单.md`（自动生成）。

---

## 0. 代码底盘：其实是“三套系统并行在用”

### A）`xobixiangqing/`：项目化“详情页/多页图”生成器（React + Flask）
- **定位**：围绕“一个项目（Project）→ 多页面（Pages）→ 生成文案与图片 → 迭代与导出”的闭环
- **数据**：SQLite（Project/Page/Task/Material/ReferenceFile/Settings…），有图片版本历史
- **优势**：结构相对完整（项目管理、持久化、版本、素材库、参考文件解析、导出）

### B）`tupian-de-tu/`：视觉工厂（FastAPI + 静态 AntDX 页面）
- **定位**：围绕“单图替换/风格化/批量处理/Excel 可视化/图片编辑/视觉标注/Agent”的工具箱
- **数据**：以 `data/inputs`、`data/outputs`、内存 job 管理为主（偏工具型）
- **优势**：功能覆盖面广（编辑器、视觉标注、Studio 计划、风格单次+批量、图片代理、Excel 导入导出）

### C）`自己版本/`：FastAPI 工具箱的另一个演进分支（含旧/半成品）
- **定位**：和 B 高度同源；Excel/标题仿写更“像 Excel智能处理”，但缺少 B 的 Studio/Style 模块
- **建议**：作为参考/回归用；整合时以 B 为主实现源

> 你说三者都持续在用且是不同东西 —— 这意味着整合的关键不是“把代码合并”，而是把它们纳入**同一个统一门户 + 同一套数据底座**。

---

## 1. 面向业务的“全量功能目录”（按用户能感知的能力拆分）

下面每个功能块都给出：你现在有哪些能力、在哪套系统里、典型入口是什么、输出是什么。

### 1.1 项目（Project）工作流：一键生成主图+详情页（多页）
**现有能力（主要来自 `xobixiangqing/`）**
- 项目创建（3 种入口）
  - 一句话/产品信息（idea）
  - 粘贴大纲（outline）
  - 粘贴逐页描述（description）
- 大纲：自动生成 / 手动编辑 / 拖拽排序 / AI 迭代改大纲（refine）
- 描述：批量生成 / 单页生成 / 手动编辑 / AI 迭代改描述（refine）
- 生图：批量生成 / 单页生成
- 改图：自然语言修改单页图片（可带“上下文图片”：模板、描述中图片、额外上传）
- 图片版本：每页保留历史版本、可切换当前版本
- 模板：项目模板图上传/删除（用于统一风格或构图参考）
- 风格描述：不用模板图时，提供“风格描述文本”作为统一风格控制
- 导出：整项目图片打包 ZIP 下载（JPG）
- 历史：项目列表、打开、批量删除、改标题（前端实现）

**入口（前端页面）**
- `xobixiangqing/frontend/src/pages/Home.tsx`：新建项目（含上传素材、参考文件、模板/风格描述）
- `xobixiangqing/frontend/src/pages/OutlineEditor.tsx`：大纲编辑/AI 改大纲
- `xobixiangqing/frontend/src/pages/DetailEditor.tsx`：描述编辑/AI 改描述
- `xobixiangqing/frontend/src/pages/ImagePreview.tsx`：生图/改图/版本/导出
- `xobixiangqing/frontend/src/pages/History.tsx`：历史项目

**后端 API（摘要）**
- 项目：`/api/projects`、`/api/projects/<id>`、`/api/projects/<id>/generate/*`、`/api/projects/<id>/refine/*`
- 页面：`/api/projects/<id>/pages/*`
- 任务：`/api/projects/<id>/tasks/<task_id>`
- 导出：`/api/projects/<id>/export/images`

**输出/存储**
- DB：Project/Page/Task/PageImageVersion/…
- 文件：`xobixiangqing/backend/uploads/…`（模板、页面图、素材、导出、MinerU 提取文件）

---

### 1.2 素材库（Asset/Material）：上传、生成、复用
**现有能力（主要来自 `xobixiangqing/`）**
- 上传素材（支持：全局素材、项目素材）
- 列表查看、删除
- “素材生成器”：输入 prompt 生一张素材图（异步任务）
- “产品替换（素材模式）”：`mode=product_replace`，要求：参考构图图 + 至少一张产品图
- 素材关联：把全局素材一键关联到某个项目（用于“先上传再建项目”的流程）
- 素材 caption：批量给素材做图片描述（方便后续 prompt/检索/展示）

**入口（前端页面/组件）**
- `xobixiangqing/frontend/src/pages/Home.tsx`：未建项目时也能上传素材（全局）
- `xobixiangqing/frontend/src/pages/ImagePreview.tsx`：素材选择器、素材生成器
- `xobixiangqing/frontend/src/components/shared/MaterialSelector.tsx`：素材库选择器（支持 project_id=all/none）
- `xobixiangqing/frontend/src/components/shared/MaterialGeneratorModal.tsx`：素材生成
- `xobixiangqing/frontend/src/components/shared/ProductReplaceModal.tsx`：产品替换（素材模式）

**后端 API（摘要）**
- `/api/projects/<id>/materials`、`/api/projects/<id>/materials/upload`、`/api/projects/<id>/materials/generate`
- `/api/materials?project_id=all|none`、`/api/materials/upload`、`/api/materials/<id>`
- `/api/materials/associate`（把素材关联到项目）
- `/api/materials/caption`（图片描述）

**输出/存储**
- DB：Material（可为空 project_id 代表全局）
- 文件：`uploads/{projectId}/materials/*` 或 `uploads/materials/*`

---

### 1.3 参考文件库（Reference Files）：上传、解析、入 prompt
**现有能力（`xobixiangqing/` 独有且很值钱）**
- 上传参考文件（支持：pdf/doc/docx/xlsx/xls/csv/txt/md）
- 异步解析状态：pending/parsing/completed/failed
- 解析引擎：
  - 文本/markdown：直接读（并可对 markdown 图片做 caption）
  - 表格：解析为 markdown 表格（轻量）
  - PDF/Office：走 MinerU 提取成 markdown + 资源文件；并对图片做 caption（Gemini/OpenAI 格式皆可）
- 文件可“全局”或“绑定项目”
- 解析后内容（markdown）会回填到 DB，用于下游提示词强化

**入口（前端）**
- `xobixiangqing/frontend/src/pages/Home.tsx`：上传文件 + 自动触发解析
- `xobixiangqing/frontend/src/components/shared/ReferenceFileSelector.tsx`：把全局文件关联到项目

**后端 API（摘要）**
- `/api/reference-files/upload`
- `/api/reference-files/<id>/parse`、`/api/reference-files/<id>`（get/delete）
- `/api/reference-files/project/<project_id>`（列项目文件）
- `/api/reference-files/<id>/associate|dissociate`
- 文件服务：`/files/mineru/<extract_id>/...`

---

### 1.4 设置（Settings）：API Key/BaseURL/模型/并发/语言
**现有能力（`xobixiangqing/` 里最完整）**
- AI Provider 格式：gemini/openai（并可扩展 vertex）
- Base URL、API Key（持久化到 DB Settings）
- 文本/图片/图片识别模型
- MinerU base/token
- 默认输出语言（zh/en/ja/auto）
- 并发：描述/图片 worker 数
- 连接测试（用当前配置对 provider 发一次轻量请求）

**入口（前端）**
- `xobixiangqing/frontend/src/pages/Settings.tsx`

**后端 API（摘要）**
- `/api/settings`（get/put）
- `/api/settings/reset`
- `/api/settings/test-connection`

---

### 1.5 单图替换（Factory/Replace）：参考主图构图 + 产品图 = 新主图
**现有能力（以 `tupian-de-tu/` 为主）**
- 单图替换（完整流程）：上传产品图 + 参考图 → 分析 → 生成
- 仅分析：只输出参考/产品分析与生成 prompt（不生成）
- 仅生成：直接给 prompt 生成（不重新分析）
- 预览生成：512 低清预览（加速交互迭代）
- 参数控制：quality(1K/2K/4K)、aspect_ratio、platform/image_type/style/background/language 等

**入口（前端页面）**
- `tupian-de-tu/frontend/single-antdx.html`（最完整：含 Studio/视觉标注/编辑器预览）
- `tupian-de-tu/frontend/assets/js/single.js`（旧版逻辑）

**后端 API（摘要）**
- `/api/replace/single`
- `/api/replace/analyze`
- `/api/replace/generate`
- `/api/preview/generate`（低清快速预览）

**输出/存储**
- 工具型落盘：`data/outputs/replaced/*`（并返回 base64）

---

### 1.6 批量替换（Batch Replace）：Excel 驱动批量生成新主图
**现有能力（以 `tupian-de-tu/` 为主）**
- 上传 Excel 创建批量任务、查看状态、下载 ZIP（支持未完成的“部分下载”）
- 前端也支持“前端解析完 items 后，直接 create-from-items”（绕开后端映射）
- 任务控制：暂停/恢复/进度/导出（注意：目前入口在 `/api/batch/*`，语义有点乱，见第 3 节）

**入口（前端页面）**
- `tupian-de-tu/frontend/batch-antdx.html`
- `tupian-de-tu/frontend/assets/js/batch.js`

**后端 API（摘要）**
- `/api/replace/batch/upload`
- `/api/replace/batch/create-from-items`
- `/api/replace/batch/start/{job_id}`
- `/api/replace/batch/{job_id}`
- `/api/replace/batch/{job_id}/download`
- 以及 `/api/batch/{job_id}/pause|resume|progress|export`（与上面 job_id 实际是同一套 batch_manager）

---

### 1.7 Excel 智能处理（表格可视化 + 标题仿写 + 图片代理 + 导出）
**现有能力（以 `tupian-de-tu/` 为主；`Excel智能处理/` 是可拷贝子集）**
- 上传 Excel/CSV，返回列名 + 预览行
- 字段映射解析：
  - “智能处理模式”：skuid/title/images/price/category 等
  - “批量替换模式”：reference_image/product_image/product_name/custom_text/requirements 等
- 表格 UI：table / gallery 两种视图、搜索过滤、分页、选择行
- 图片代理：外链绕防盗链（Shopee/淘宝/京东 referer 处理），支持多图 URL 取第一张
- 标题仿写：单条 / 批量（支持语言、风格、要求、最大长度）
- 导出：回写新标题/新图片 URL/状态到原表（overwrite 或 append），导出 csv/xlsx
- 会话恢复：本地 localStorage 保存解析结果与选择状态（V2 前端实现）

**入口（前端页面）**
- `tupian-de-tu/frontend/batch-import.html`
- `tupian-de-tu/frontend/assets/js/batch-import-v2.js`（最完整版本）

**后端 API（摘要）**
- `/api/excel/upload`
- `/api/excel/parse`
- `/api/excel/parse-replace`
- `/api/excel/export`
- `/api/excel/download/{filename}`
- `/api/excel/cleanup/{file_id}`
- `/api/proxy-image`
- `/api/title/rewrite`、`/api/title/batch-rewrite`

---

### 1.8 Studio（计划 + 风格化生图）
**现有能力（`tupian-de-tu/` 独有）**
- Studio 生成计划（Lovart-style）：输入 profile/brief/assets → 输出结构化 plan + 3 个方向（A/B/C）
- 风格单次：
  - 有产品图：`/api/style/single`（产品图 + 可选风格参考图 + preset/options/requirements）
  - 无产品图：`/api/style/text`（文生图 + 可选风格参考图）
  - 支持 copy_text（图中文字）+ 自动翻译到目标语言
- 风格批量：`/api/style/batch/*`
  - create-from-items、list、status、cancel、download
- 输出落盘到 `data/outputs/studio/*`，同时可回传 base64

**入口（前端页面）**
- `tupian-de-tu/frontend/single-antdx.html`：内置 Studio 引导与方向选择
- `tupian-de-tu/frontend/batch-import.html`：V2 支持发起 style batch（把 Excel 行映射成 items）

---

### 1.9 图片编辑器（手动编辑）
**现有能力（`tupian-de-tu/` 为主）**
- 基础编辑：crop/resize/rotate/adjust/filter/add-text/batch-edit
- 预览：`/api/editor/preview`
- （潜在）可作为所有模块的“通用后处理”能力（例如：导出前统一加字/加价签/套模板）

**入口（前端页面）**
- `tupian-de-tu/frontend/editor-antdx.html`
- `tupian-de-tu/frontend/single-antdx.html` 内也调用 `/api/editor/preview`

---

### 1.10 视觉标注（Vision Annotate）
**现有能力（`tupian-de-tu/` 为主）**
- analyze：对 reference/product/result 三类图片给 3-5 个关键标注点（含坐标百分比）
- describe：给图片生成“用于 prompt 的描述文本”（带 context）
- 主要用于：
  - 帮用户理解“参考图风格要点”
  - 指导生成后哪里不自然要改

**入口（前端页面）**
- `tupian-de-tu/frontend/single-antdx.html`

---

### 1.11 Agent（对话助手）
**现有能力（`tupian-de-tu/` 为主）**
- `/api/chat`：中文按钮式建议（严格输出约束），并会给出可用于预览/生成的 prompt（data.custom_prompt）
- `/api/chat/expand-prompt`：把一句话扩写成专业电商主图描述（50-80字）
- `/api/smart-chat`：另一套“更智能”的对话（前端 `chat-antdx.html` 调用）

**入口（前端页面）**
- `tupian-de-tu/frontend/chat-antdx.html`
- `tupian-de-tu/frontend/single-antdx.html`（内置对话驱动）

---

## 2. 功能重复/冲突点（整合时必须先定“唯一真相”）

### 2.1 Excel：至少 3 套实现
- `tupian-de-tu/backend/app/api/excel_import.py`（最完整，含 parse-replace + overwrite 导出）
- `tupian-de-tu/Excel智能处理/backend/app/api/*`（可拷贝子集）
- `自己版本/backend/app/api/excel_import.py`（同源但更旧/不同步）

**建议**：以后只保留一套（推荐以 `tupian-de-tu` 为主），其它变成 library 或归档。

### 2.2 Batch 的语义混乱（同一个 job_id 出现在两个路由空间）
- `/api/replace/batch/*`（batch_replacer 的核心入口）
- `/api/batch/{job_id}/pause|resume|progress|export`（也是 batch_replacer 的 job 控制）
- `/api/batch/{batch_id}/start|status|download`（另一个“pipeline 批量 SKU”系统）

**建议**：统一成一个 Job API：`/api/jobs/*`（状态机统一），并把旧 `/api/batch` 明确标记为 legacy 或迁移掉。

### 2.3 设置/Key 管理两套哲学冲突
- `xobixiangqing`：Settings 存 DB（全局），前端设置页可修改
- `tupian-de-tu`：配置来自 env + 请求头 runtime_config（更偏“工具/临时配置”）

**你希望共享项目/素材/任务** ⇒ 必须统一到“项目级/用户级/全局”三层配置，并且要有权限与脱敏。

### 2.4 单图替换在两套系统都有雏形
- `tupian-de-tu`：Replace 是主功能（有 analyze/preview/参数体系）
- `xobixiangqing`：把“产品替换”做成 `materials/generate mode=product_replace`（融入项目化素材库）

**建议**：把它们抽象成同一类 Job：`JobType=IMAGE_REPLACE`，底层可选“Replace 引擎 A/B”，输出统一落到 Asset/Version。

---

## 3. 哪些模块最值得复用（整合后可作为“公共底座”）

### 3.1 共享实体模型（必须优先统一）
你说要共享：Project / Asset(Material+File) / Job(Task) —— 这是整合成败的关键。

建议最终统一出三张“核心表/核心概念”（名字可变，语义要定死）：
- **Project**：项目与品牌档案、默认比例/风格、与 Excel 批量任务的关联
- **Asset**：所有输入/输出文件统一入库（产品图/参考图/模板图/生成图/导出文件/Excel源文件/解析中间产物…）
- **Job**：所有耗时/可追踪的动作（生成大纲/生成描述/生图/改图/替换/风格化/标题仿写/导出/解析参考文件/解析 Excel）

### 3.2 `xobixiangqing` 的长板：持久化与版本
- PageImageVersion（图片版本历史）
- ReferenceFile + MinerU 解析管线（对跨境电商“资料/竞品/产品说明”非常实用）
- Material 库（全局/项目级）

### 3.3 `tupian-de-tu` 的长板：工具箱能力
- Vision Annotate（标注+描述）
- Image Editor（手动编辑）
- Studio Plan + Style Single/Batch（“风格化生产线”）
- Image Proxy（绕防盗链）
- Excel 导入/导出（可视化工作台 + overwrite 导出）

---

## 4. 未完成/缺失能力（按你“整合成平台”会立刻撞到的坑）

### 4.1 明确未完成（代码里标了 TODO）
- `xobixiangqing/backend/controllers/template_controller.py`：系统模板列表是空实现
- `tupian-de-tu/frontend/chat-antdx.html`：对话页里“调用生成 API”有 TODO（目前更像聊天演示）
- `自己版本/frontend/editor.html`：平台优化 API TODO（说明你们想做“按平台规格一键适配”，但没接上）
- `Excel智能处理/frontend/assets/js/batch-import-v2.js`、`自己版本/frontend/assets/js/batch-import-v2.js`：批量图片生成 TODO（但 `tupian-de-tu` 的版本已实现/更完整）

### 4.2 作为“共享平台”缺失（现在基本没有）
- 账号/权限（至少要有一个最小鉴权，否则 Key/项目数据暴露风险极高）
- Job/Asset 的统一检索、审计、回滚（尤其是“批量覆盖导出”）
- 统一的“项目级配置/品牌档案”（Studio profile 与 Project 应该打通）
- 统一的“标签/分类/检索”（素材与参考文件太多时，没有检索会崩）
- 统一的“多语言策略”（标题仿写/文案生成/图片文字翻译现在分散）

---

## 5. 统一门户（Ant Design X）页面规划：做多少页、怎么分

你要求：Excel/工厂/编辑器/Agent 独立页面 + 共享项目/素材/任务。

### 5.1 建议的“主导航”= 8 个（够用且不臃肿）
1. **仪表盘**（Dashboard）
2. **项目**（Project 工作流：大纲/描述/预览/导出）
3. **Excel 工作台**（导入→映射→批处理→导出）
4. **视觉工厂**（单图替换 / 批量替换 / Studio / 风格批量）
5. **编辑器**（手动编辑 + 作为任何模块的后处理）
6. **资源库**（素材/模板/参考文件）
7. **任务中心**（所有 Job 的列表/过滤/详情/重试/取消/下载）
8. **设置**（全局/项目级/用户级配置）

> **Agent 建议做成“全局抽屉”+ 独立页面都保留**：  
> - 独立页面用于长对话与“方案沉淀”；  
> - 抽屉用于在任何页面随时问“怎么改/怎么生成”。

### 5.2 建议的路由结构（React + Ant Design + Ant Design X）
- `/` 仪表盘：最近项目/最近任务/快捷入口
- `/projects` 项目列表（历史）+ 新建
- `/projects/:id/outline` 大纲
- `/projects/:id/detail` 描述
- `/projects/:id/preview` 生图/改图/版本/导出

- `/excel` Excel 任务列表
- `/excel/:jobId` Excel 任务详情（映射、处理、对比、导出）

- `/factory/single` 单图替换（含 analyze/preview/studio/vision/编辑器预览）
- `/factory/batch` 批量替换（任务、进度、部分下载）
- `/factory/style-batch` 风格批量（列表/状态/下载）
- `/factory/platform-specs` 平台规格（可选：做成配置弹窗/抽屉）

- `/editor` 图片编辑器（也可通过 URL 参数打开某个 asset）

- `/assets` 资源库（tab：素材/模板/参考文件/导出文件/Excel源文件）

- `/jobs` 任务中心（统一）

- `/agent` 助手（独立页面）
- `/settings` 设置

### 5.3 跨页面“公共组件”（共享的关键）
为了真正共享 Project/Asset/Job，建议每个页面都能打开：
- 顶部 **Project Switcher**：当前项目/切换/新建
- 右侧 **Assets Drawer**：搜索、筛选、拖拽把素材加入当前任务
- 右侧 **Jobs Drawer**：当前运行任务、进度、日志、取消/重试
- 右侧 **Agent Drawer（Ant Design X）**：对话并可一键把建议填充到表单（prompt、requirements、标题等）

---

## 6. 你下一步可以让我做什么（建议顺序）

1) 我先把这份“功能盘点”落成更硬的“功能矩阵表”（功能×目录×入口×数据落点×复用建议），并标出：重复/冲突/优先统一项。  
2) 基于你的“共享 Project/Asset/Job”的要求，给出 **统一数据模型草案（表字段级）** + **Job 状态机**。  
3) 再给出 “Ant Design X 门户” 的页面原型（信息架构 + 组件树 + 路由 + API 适配策略）。

