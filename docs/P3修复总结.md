# P3 é—®é¢˜ä¿®å¤æ€»ç»“

## ä¿®å¤å®Œæˆæ—¶é—´
2026-01-12

## ç›®æ ‡
- ä¿®å¤é—¨æˆ·æ§åˆ¶å°å…³é”®æŠ¥é”™ï¼ˆå°¤å…¶æ˜¯æ— é™å¾ªç¯æ¸²æŸ“ï¼‰ã€‚
- æ ¡å‡†äº‘é›¾ï¼ˆYunWuï¼‰API çš„ Base/Key å¤„ç†é€»è¾‘ï¼Œä¿è¯â€œæµ‹è¯•è¿æ¥/ä¿å­˜/åŒæ­¥â€å¯ç”¨ä¸”ä¸è¯¯åˆ¤ã€‚
- è®©è§†é¢‘å·¥å‚ï¼ˆvideo-workstationï¼‰èƒ½ç¨³å®šå¯åŠ¨å¹¶ä¸é—¨æˆ·é…ç½®è”åŠ¨ã€‚

## ä¿®å¤å†…å®¹

### 1) âœ… ä¿®å¤ Settings / ä¸»å›¾å·¥å‚é¡µé¢æ— é™å¾ªç¯æ¸²æŸ“ï¼ˆMaximum update depth exceededï¼‰

**ç°è±¡**ï¼š
- è¿›å…¥ `/settings`ã€`/factory/single` ä¼šå‡ºç°å¤§é‡ `Maximum update depth exceeded`ï¼Œé¡µé¢å¡é¡¿/æŠ–åŠ¨ã€‚

**æ ¹å› **ï¼š
- `useAgentBridgeSlots()` çš„ `useEffect` ä¾èµ– `slots` å¯¹è±¡æœ¬èº«ï¼ˆæ¯æ¬¡ render éƒ½æ˜¯æ–°å¯¹è±¡ï¼‰â†’ æ¯æ¬¡ render éƒ½ `setSlots` â†’ è§¦å‘çˆ¶å¸ƒå±€æ›´æ–° â†’ å† render â†’ æ— é™å¾ªç¯ã€‚
- `useWorkbenchToolbarSlots()` çš„ cleanup effect åœ¨æŸäº›æƒ…å†µä¸‹ä¹Ÿä¼šè§¦å‘é‡å¤æ›´æ–°ï¼ˆä¾èµ–å‡½æ•°å¼•ç”¨/StrictMode è¡Œä¸ºå åŠ ï¼‰ã€‚

**ä¿®å¤**ï¼š
- `frontend/src/layout/agentBridge.tsx`ï¼šé‡æ„ `useAgentBridgeSlots`ï¼Œæ”¹ä¸ºæ”¯æŒä¼ å…¥ç¨³å®šçš„ `deps`ï¼Œå¹¶ä½¿ç”¨ ref+unmount cleanupï¼Œé¿å…ä¾èµ– slots å¯¹è±¡å¯¼è‡´å¾ªç¯ã€‚
- `frontend/src/layout/workbenchToolbar.tsx`ï¼šåŒæ ·ç”¨ ref+unmount cleanup çš„æ–¹å¼é‡æ„ï¼Œé¿å… cleanup ä¾èµ–å˜åŒ–è§¦å‘å¾ªç¯ã€‚
- æ›´æ–°ä»¥ä¸‹é¡µé¢çš„è°ƒç”¨æ–¹å¼ï¼Œä¼ å…¥ç¨³å®š depsï¼š
  - `frontend/src/pages/MainFactoryLandingPage.tsx`
  - `frontend/src/pages/MainFactoryCanvasPage.tsx`
  - `frontend/src/pages/FactorySinglePage.tsx`
  - `frontend/src/pages/FactoryDetailPage.tsx`
  - `frontend/src/pages/ExcelDatasetPage.tsx`
- `frontend/src/pages/PortalSettingsPage.tsx`ï¼šå¢åŠ éšè— Formï¼ˆä»…åœ¨â€œæŒ‰æ¨¡å—â€Tab æœªæŒ‚è½½æ—¶ï¼‰ä»¥æ¶ˆé™¤ `useForm` æœªè¿æ¥çš„æ§åˆ¶å°æŠ¥é”™ã€‚

### 2) âœ… äº‘é›¾ APIï¼šBase URL è§„èŒƒåŒ– + Key å…œåº•å¤ç”¨

**é—®é¢˜ç‚¹**ï¼š
- äº‘é›¾è§†é¢‘æ¥å£è·¯å¾„æœ¬èº«å¸¦ `/v1`ï¼ˆå¦‚ `/v1/video/create`ï¼‰ï¼Œå¦‚æœç”¨æˆ·æŠŠ Base é…æˆ `.../v1`ï¼Œå°±ä¼šå‡ºç° `/v1/v1/...` çš„æ‹¼æ¥é”™è¯¯ã€‚
- ç”¨æˆ·é€šå¸¸åªé…ç½®ä¸€ä¸ªä¸» Keyï¼ˆå¤šæ¨¡æ€/è¯†å›¾/èŠå¤©/åˆ†æï¼‰ï¼Œæœªå¿…ä¼šå•ç‹¬é…ç½®â€œäº‘é›¾è§†é¢‘ Keyâ€ï¼Œå¯¼è‡´æµ‹è¯•/è°ƒç”¨å¤±è´¥ã€‚
- â€œæµ‹è¯•è¿æ¥â€ä¸åº”è¢«ä½™é¢ä¸è¶³è¯¯åˆ¤ä¸ºé…ç½®é”™è¯¯ï¼ˆåŸå…ˆç”¨ chat.completions æ¢æµ‹æ—¶å¯èƒ½è¢« quota æ‹¦æˆªï¼‰ã€‚

**ä¿®å¤**ï¼š
- `backend/controllers/settings_controller.py`ï¼š
  - OpenAI æ ¼å¼ `test-connection` æ”¹ä¸ºè½»é‡ `GET /v1/models` æ¢æµ‹ï¼ˆä¸å†ç”¨ chat.completionsï¼‰ï¼Œé™ä½è¢« quota è¯¯åˆ¤çš„æ¦‚ç‡ã€‚
  - ä¿å­˜æ—¶è‡ªåŠ¨å¤„ç† `yunwu_api_base`ï¼ˆå»æ‰å°¾éƒ¨ `/v1`ï¼‰ã€‚
  - æµ‹è¯•äº‘é›¾è§†é¢‘æ—¶ï¼šè‹¥ `yunwu_api_key` ä¸ºç©ºï¼Œè‡ªåŠ¨å¤ç”¨ä¸» `api_key`ã€‚
- `backend/controllers/module_settings_controller.py`ï¼š
  - æ¨¡å—çº§äº‘é›¾è§†é¢‘æµ‹è¯•åŒæ ·æ”¯æŒâ€œäº‘é›¾ Key ä¸ºç©º â†’ å¤ç”¨ä¸» Keyâ€ã€‚

### 3) âœ… è§†é¢‘å·¥å‚ï¼ˆvideo-workstationï¼‰ç¨³å®šå¯åŠ¨ + ä¸é—¨æˆ·è®¾ç½®è”åŠ¨

**é—®é¢˜ç‚¹**ï¼š
- ç«¯å£/URL æ‹¼æ¥ä¸ä¸€è‡´ï¼ˆå¦‚ upload/download è¿”å›çš„ fullUrl ç«¯å£ä¸ç»Ÿä¸€ï¼‰ã€‚
- äº‘é›¾ Base å¯èƒ½è¢«é…ç½®æˆå¸¦ `/v1`ï¼Œå¯¼è‡´ `/v1/v1`ã€‚
- `node --watch` åœ¨ Windows ä¸Šå®¹æ˜“è§¦å‘ç«¯å£å ç”¨/é‡å¯ä¸ç¨³å®šï¼ˆEADDRINUSEï¼‰ã€‚

**ä¿®å¤**ï¼š
- `video-workstation/server/src/services/yunwu.js`ï¼š
  - å¢åŠ äº‘é›¾ Base è§„èŒƒåŒ–ï¼ˆå»æ‰å°¾éƒ¨ `/v1`ï¼‰ï¼Œå¹¶ä» `settings.json` è¯»å–é…ç½®ï¼ˆä¸é—¨æˆ·åŒæ­¥ä¸€è‡´ï¼‰ã€‚
- `video-workstation/server/src/routes/settings.js`ï¼š
  - ä¿å­˜/æµ‹è¯•äº‘é›¾é…ç½®æ—¶ç»Ÿä¸€è§„èŒƒåŒ– Baseã€‚
- `video-workstation/server/src/routes/upload.js`ã€`video-workstation/server/src/routes/video.js`ï¼š
  - è¿”å›çš„ `fullUrl` é»˜è®¤ç«¯å£ç»Ÿä¸€ä¸º `4000`ã€‚
- `video-workstation/server/package.json`ï¼š
  - dev è„šæœ¬ä» `node --watch` æ”¹ä¸º `node src/index.js`ï¼Œæå‡ç¨³å®šæ€§ã€‚
- é—¨æˆ·ä¾§ç»§ç»­é€šè¿‡ `POST /api/tools/video-workstation/sync-settings` ä¸€é”®åŒæ­¥è§†é¢‘å·¥å‚é…ç½®ã€‚

### 4) âœ… ä»“åº“ç»“æ„ä¸æœ¬åœ°æ–‡ä»¶æ¸…ç†

**é—®é¢˜ç‚¹**ï¼š
- æ ¹ä»“åº“å­˜åœ¨ `xobixiangqing` çš„æ®‹ç•™ submodule gitlinkï¼Œä½†ç¼ºå¤± `.gitmodules`ï¼Œå¯¼è‡´å˜æ›´æ— æ³•æ­£å¸¸æäº¤/æ¨é€ã€‚
- `.claude/settings.local.json` å±äºæœ¬åœ°é…ç½®ï¼Œä¸åº”çº³å…¥ç‰ˆæœ¬ç®¡ç†ã€‚

**ä¿®å¤**ï¼š
- å°† `xobixiangqing` ä» submodule å½¢å¼è½¬æ¢ä¸ºæ™®é€šç›®å½•çº³å…¥åŒä¸€ä»“åº“ç®¡ç†ï¼ˆä¾¿äºâ€œèåˆç‰ˆâ€ç»Ÿä¸€æäº¤ï¼‰ã€‚
- `.gitignore` å¢åŠ  `.claude/`ã€`è‡ªå·±ç‰ˆæœ¬/`ã€‚
- ä» Git ç§»é™¤ `.claude/settings.local.json`ï¼ˆä¿ç•™æœ¬åœ°æ–‡ä»¶ä½†ä¸å†è·Ÿè¸ªï¼‰ã€‚

### 5) ğŸ“„ æ–°å¢è§„åˆ’æ–‡æ¡£ï¼ˆç•™æ¡£ï¼‰
- `è§†é¢‘å·¥å‚_åç»­å¼€å‘è§„åˆ’_v1.md`ï¼šæŠŠâ€œè§†é¢‘å·¥å‚â€åç»­çš„é¡¹ç›®åŒ–é—­ç¯ã€åˆ†é•œ/è„šæœ¬/ç”Ÿæˆ/å…¥åº“ç­‰èƒ½åŠ›æ‹†è§£ä¸ºå¯è½åœ°çš„å¼€å‘è·¯çº¿ã€‚

