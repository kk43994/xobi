# Xobi 项目代码审阅（初稿）

日期：2026-01-09  
范围：`c:\Users\zhouk\Desktop\xobi`（包含多个“版本/子项目”）

## 1. 现状概览（目录=不同实现/版本）

你现在的工作区并不是“一个项目”，而是**至少三套并行实现**叠在一起，导致功能与代码边界非常混乱：

1) `xobixiangqing/`（相对更“产品化”的一套）
- **前端**：React 18 + Vite + TS + Tailwind + Zustand + React Router（`xobixiangqing/frontend/`）
- **后端**：Flask + SQLAlchemy + SQLite + Alembic（`xobixiangqing/backend/`）
- **运行**：`docker-compose.yml`、前后端各自 `Dockerfile`、有 `pytest`/前端测试脚本
- **核心能力**：项目（Project）→ 大纲 → 描述 → 生图 → 改图 → 素材/参考文件 → 导出 ZIP

2) `tupian-de-tu/`（偏“流水线/工厂”的一套）
- **后端**：FastAPI（`tupian-de-tu/backend/app/`）
- **前端**：静态 HTML（`tupian-de-tu/frontend/*.html`）
- **核心能力**：单图/批量替换、图片编辑器、视觉标注、预览、Agent、标题仿写、Excel 导入导出等
- **额外**：包含一个被“抽出来方便拷贝融合”的子项目：`tupian-de-tu/Excel智能处理/`

3) `自己版本/`（与 `tupian-de-tu` 高度同源的另一套）
- **后端**：FastAPI（`自己版本/backend/app/`）
- **前端**：静态 HTML（`自己版本/frontend/*.html`，含 `batch-import.html`）
- **文档/脚本**：大量方案、总结、测试脚本（如 `自己版本/项目整合方案.md`）

> 结论：当前“乱”的根因不是某个模块写得不好，而是**没有一个明确的主线工程**，功能被多套实现分别承载。

## 2. 核心业务流程（按“功能链路”梳理）

### 2.1 电商图生成（项目化工作流）
主要出现在 `xobixiangqing/`：
- Project 创建（idea/outline/description 三种入口）→ 生成大纲 → 批量生成描述 → 批量生图
- 单页：改描述 / 生图 / 自然语言改图
- 资产：模板图、素材图、参考文件解析（含 MinerU）→ 影响生图提示词与参考图
- 导出：打包下载 JPG ZIP

关键 API（Flask）：
- 项目：`/api/projects`、`/api/projects/<id>/generate/*`、`/api/projects/<id>/refine/*`
- 页面：`/api/projects/<id>/pages/<page_id>/*`
- 素材：`/api/projects/<id>/materials/*` + 全局 `/api/materials/*`
- 设置：`/api/settings/*`
- 文件：`/files/...`

### 2.2 表格驱动的批量处理（Excel/CSV → 批量改标题/改图/导出）
主要出现在 `tupian-de-tu/` 与其子项目 `Excel智能处理/`，以及 `自己版本/`：
- 上传 Excel/CSV → 字段映射/解析 → 列表可视化（含图片代理绕防盗链）
- 批量标题仿写（云雾 chat-completions）/批量任务管理/结果导出

关键 API（FastAPI，举例）：
- `POST /api/excel/upload|parse|export`
- `GET /api/proxy-image`
- `POST /api/title/rewrite`

### 2.3 图片编辑/预览/视觉标注/Agent
主要在 FastAPI 版本：
- 图片编辑：裁剪/旋转/加字/滤镜/批量编辑（`tupian-de-tu/backend/app/api/image_editor.py`）
- 视觉标注/分析：`vision_annotate.py`
- Agent/Smart Agent：`agent.py`、`smart_agent.py`

## 3. 主要问题与技术债（按优先级）

### P0：没有“主线工程”，导致所有问题都被放大
- 现在同一功能（Excel、标题仿写、批量任务、前端页面）在不同目录重复出现，维护成本指数级上升。
- 建议先把“哪些目录还在用/准备发版”定下来，否则任何重构都是在给未来埋雷。

### P0：安全与多租户风险（如果要对外/多人使用）
- `xobixiangqing/` 设置里可写入 API Key（`xobixiangqing/backend/models/settings.py` + `.../controllers/settings_controller.py`），但**没有鉴权**，部署后会变成“任何人都能改全局 Key”。
- FastAPI 版本允许从请求头直接传入 Key（`tupian-de-tu/backend/app/middleware/config_middleware.py`），如果面向公网需明确威胁模型（滥用/盗刷/日志泄露）。
- FastAPI 版本默认 `allow_origins=["*"]`（`tupian-de-tu/backend/app/main.py`），生产需要收紧。

### P1：异步任务/并发与 SQLite 的组合存在稳定性隐患
`xobixiangqing/`：
- 使用 `ThreadPoolExecutor` + 任务状态（`backend/services/task_manager.py`）并行跑生成；SQLite + 多线程在高并发下容易遇到锁竞争。
- 任务“活跃状态”部分是**内存态**（进程重启会丢），与数据库 Task 表混用，后续扩展到多进程/多实例会出问题。

### P1：分层不稳定（Controller/Service 边界不清）
- Flask controller 文件普遍偏大（如 `project_controller.py`、`page_controller.py`），包含较多业务细节和辅助函数。
- `task_manager.py`、`ai_service.py` 体量大且职责混杂（pipeline/后处理/提示词策略/并发/DB 写入交织）。

### P2：前端实现分裂、接口形态不一致
- React（`xobixiangqing/frontend/`）与静态 HTML（`tupian-de-tu/frontend/`、`Excel智能处理/frontend/`、`自己版本/frontend/`）并存。
- API 返回格式、错误码、命名风格在 Flask 与 FastAPI 之间不统一，导致前端难以复用。

### P2：仓库卫生与可维护性
- 多个目录下存在运行产物（如 `__pycache__`、本地 `node_modules`、大体积图片等），虽然可能被 ignore，但会干扰协作与审阅。
- 目录/文件命名不具备可长期维护的语义（例如 `tupian-de-tu`、`xobixiangqing`），对新成员极不友好。

## 4. 分阶段治理建议（可落地）

### 阶段 A（1～2 天）：先“止血”，建立主线
1. **确定主线目录**（只能选一个作为“真项目”）：`xobixiangqing/` 或 `tupian-de-tu/`（含 Excel 子模块）  
2. 其余目录移动到 `archive/`（或单独仓库），并在根目录写一份 `README.md` 说明：
   - 主线是什么
   - 如何启动
   - 现存其他目录的用途（历史/参考/素材）
3. 明确部署形态：本地单机工具 vs 多人共享服务（影响鉴权/Key 管理/任务队列/数据库选择）

### 阶段 B（1 周）：统一 API 契约与模块边界
1. 先不重写业务，先做“契约统一”：输出一个 OpenAPI/接口文档作为单一事实来源
2. 前端统一到一个实现（建议保留 React/Vite 那套，静态 HTML 作为原型归档）
3. 后端把大 controller 拆成“薄路由 + service”，并抽出：
   - prompt 构建层
   - provider 适配层（OpenAI/Gemini/Vertex）
   - pipeline 编排层（outline/desc/image/edit/export）
   - 存储层（DB + 文件）

### 阶段 C（2～4 周）：补齐工程化与可扩展性
1. 任务系统：从“线程池 + 内存状态”升级为可持久化的 Job（至少 DB 里完整状态机；有需要再上 Celery/RQ）
2. 数据库：如果要多人协作/线上化，SQLite 早晚要换 Postgres
3. 安全：鉴权（最小化：管理口令/Token）+ Key 加密存储/不落盘策略 + CORS 收紧 + 日志脱敏

## 5. 你需要先回答的 4 个问题（决定后续路线）
1. 你们现在**实际在用/准备发版**的是：`xobixiangqing` 还是 `tupian-de-tu`（或 `自己版本`）？
2. 产品形态：只给内部同事用（单机/局域网）还是要做成多客户 SaaS？
3. 近期 2 周内必须交付的 Top3 功能是什么（生图/改图/标题仿写/Excel 批量/详情页生成…）？
4. 你们希望“项目维度”的数据能持久化到什么程度（仅文件夹 vs 数据库可追溯/可回滚）？

