# 整合蓝图 v1（新统一版本：Ant Design X 门户 + 共享 Project/Asset/Job/Dataset）

> 你确认的方向：
> - Excel 只是批量桥接手段（导入/导出为上架表）
> - 暂不做账户系统（鉴权后置，但要留钩子）
> - 主线数据底座采用 `xobixiangqing`（项目/素材/参考文件/设置等更完整）
> - `tupian-de-tu` 的强功能（画布/编辑器/视觉标注/Studio/风格批量/代理/Excel UI）必须保留
> - 每个功能选“最完整实现”做主实现源，最终统一到一个新的门户与数据模型

本蓝图解决两个核心问题：
1) **共享**：项目/素材/任务/Excel 数据集如何真正共享，而不是各跑各的  
2) **选型**：三套代码里每个能力用哪套最划算，以及如何纳入统一数据模型

---

## 1) 一句话定义“新产品”

一个面向跨境电商的“一键包办”工作台：
- 以 **Dataset（Excel 导入）** 和 **Project（项目化多图）** 为两条主线入口
- 所有生产动作统一为 **Job**（可追踪/可复用/可导出）
- 所有输入/输出统一沉淀为 **Asset**（可检索/可复用/可回滚）
- 前端统一为 **React + Ant Design + Ant Design X（Agent）**

---

## 2) 统一数据模型（建议的“唯一真相”）

> 目标：未来你们只讨论这套模型，任何模块都往这里落，不再“某功能只能在某目录用”。

### 2.1 Project（项目：详情页/多图生产）
沿用 A 的 `Project/Page/PageImageVersion`，补充最小字段即可：
- `Project.external_ref`：可存 `dataset_item_id` 或 `skuid/product_id`
- `Project.profile`：项目级偏好（比例、风格、禁词、语言等，后续替代零散的 runtime config）

### 2.2 Asset（资源：一切文件与媒体的统一抽象）
建议新增 `Asset`（或把 A 的 Material/ReferenceFile/UserTemplate/导出文件逐步纳入 Asset）：
- `asset_id`
- `type`：image / file / excel / zip / text / json
- `owner`：global / project / dataset / job
- `source`：upload / generated / imported / derived
- `uri`：统一访问路径（前端不再拼 uploads 目录）
- `meta`：尺寸、比例、格式、标签、caption、hash…
- `links`：关联到 Project/Page/DatasetItem/Job

### 2.3 Job（任务：一切耗时动作）
把 A 的 `Task` 升级为通用 `Job`（或保留 Task 但对外统一叫 Job）：
- `job_id`
- `type`：OUTLINE/DESC/IMAGE/EDIT/REPLACE/STYLE_BATCH/TITLE_REWRITE/EXCEL_IMPORT/EXCEL_EXPORT/FILE_PARSE…
- `status`：pending/running/succeeded/failed/canceled
- `progress`：total/completed/failed/percent
- `input_assets` / `output_assets`
- `context`：project_id / dataset_id / item_ids…

### 2.4 Dataset（Excel 数据集：批量桥接）
详见：`批量工作台_Excel桥接设计.md`
- Dataset 代表一次导入 + 映射规则 + 平台模板
- DatasetItem 代表每行（SKU/Listing），可关联 Project、挂载资产与任务结果

---

## 3) “选最完整实现”的规则（防止越整合越乱）

### 3.1 规则
1) **功能归域**：先定义领域（Project/Excel/Factory/Editor/Vision/Agent/Assets/Settings），再选实现源  
2) **只允许一个主实现源**：同一领域的同一子能力，只能指定一个“主实现”，其他作为参考或删除  
3) **统一落库**：任何主实现不管来自 Flask 或 FastAPI，最终都必须产出 Asset/Job，并能回写到 Project/DatasetItem  

### 3.2 当前建议的“主实现源”
- Project/版本/参考文件/MinerU/Settings：用 A（`xobixiangqing`）
- Excel 解析/导出/工作台交互/图片代理：用 B（`tupian-de-tu`）为主  
  - 标题仿写 batch：用 C 或 Excel智能处理（有 `/api/title/batch-rewrite`），再回并到 B
- Replace/Studio/Style/Editor/Vision/Canvas 标注：用 B（`tupian-de-tu`）
- C（`自己版本`）：尽量只作为“更完整子功能的来源”，抽取后并回 B/A

> 这个分配能让你们“保住各自优势”，同时让共享目标可落地。

---

## 4) 跨模块主流程（用户真正会用的闭环）

### 流程 A：Excel → 批量处理 → 上架导出
1. 导入 Excel → Dataset
2. 映射字段 → 产生 DatasetItems
3. 批量动作（标题/主图/风格/编辑器后处理）→ 产生 Job + 输出 Asset
4. 回写结果到 DatasetItem
5. 导出为平台模板 Excel（ExportProfile）→ 生成 Excel Export Asset → 下载 → 一键上架

### 流程 B：Excel → 选中若干行 → 批量生成“详情页多图项目” → 导出
1. Excel 行勾选 → “生成详情页”
2. 每行生成/绑定一个 Project（把标题/卖点/类目/图片编译成 idea_prompt）
3. Project 走 outline/desc/images（A）→ 产出 PageVersion/Assets
4. 回写到行：多图字段/zip 下载/图片 URL（按平台模板决定）
5. 导出上架表

### 流程 C：项目 → 工厂工具增强 → 回写版本 → 导出
1. 在 Project Preview 中选某张图
2. 使用画布标注/视觉分析/编辑器/Studio 方向 → 生成新的候选图
3. 候选图保存为该 Page 的新版本（PageImageVersion）+ Asset
4. 项目导出 ZIP 或回写到 DatasetItem（如果该项目绑定了某个 Excel 行）

---

## 5) 门户页面规划（与你想要的“独立页面”一致）

页面与职责见：`页面规划_统一门户IA.md`

补充建议（结合你“Excel 是桥接、要上架导出”）：
- Excel 页顶部必须明确：当前 Dataset 的“平台模板/导出配置”
- Excel 页每行必须能看到：关联 Project、产物图片、标题改写、状态、错误原因
- 任何页面都要能打开：Agent 抽屉 + Assets 抽屉 + Jobs 抽屉（真正共享）

---

## 6) 实施路线图（建议按 4 个里程碑推进）

### M1：先做“新门户壳”+ 统一导航（不动后端逻辑也能跑）
- React + Ant Design + Ant Design X
- 路由按 IA 搭起来，优先把 B 的静态页面能力“迁移/嵌入”进新壳
- 目标：团队开始在同一个 UI 里工作，而不是跳三个项目

### M2：落地 Asset/Job 的统一层（共享能力开始生效）
- 新增/改造 API：Job 列表/详情、Asset 列表/预览/下载
- 把 B 的输出（replace/style/editor）保存为 Asset，并可从资源库复用

### M3：落地 Dataset（Excel 桥接）作为批量中枢
- Excel 导入=Dataset，批量动作=Job，导出=ExportProfile
- 支持“行→项目”的桥接（批量生成详情页/多图）

### M4：体验增强与风险收敛
- 结构化输出、检索、任务可观测性
- 决定是否补最小鉴权（若要多人共享/公网必须提前）

---

## 7) 你需要先确认的 2 个信息（我才能把 ExportProfile 定到可落地）

1) 近期要优先支持的上架平台模板 Top1-2 是哪些？  
   - 你已确认优先支持：**Shopee / SHEIN / Amazon / TikTok / Temu**  
   - 但 v1 仍建议先选 Top1-2 做成预置模板（不同平台列结构差异很大）
2) 图片字段习惯：单列逗号分隔，还是多列展开（image1/image2/...）？  
   - 你已选择：**B 多列展开**（image1/image2/...）  
   - 说明见：`批量工作台_Excel桥接设计.md`
